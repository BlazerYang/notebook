# 新建上线单失败原因排查

## 现象
1. 点击新增上线单按钮时，回显错误“上线单不存在”，实际上上线单已经创建了，此时每次提交都会回显相同的信息，但是实际上已经创建成功了
2. 这个问题是偶现，但是频率并不低
3. 只在生产环境出现过，没有在测试环境出现过

## 排查
1. 定位到错误原因是在新建上线单完成之后，发送邮件使用上线单id查询时查询不到对应的上线单信息

## 原因猜想
1. 发起插入和查询的不是同一个mysql会话，然后插入的事务提交后尚未生效，查询的请求就过来了？
    TP在同一个请求中使用的是同一个会话，应该不是这个原因
2. 测试环境和生产环境的数据库版本一致，唯一区别是线上的数据自带全量备份和增量备份功能，是否是因为备份的运行导致提交的事务没有实时生效？

Q: mysql读写分离，用的是一个ip+port来读数据库么？
A: 利用mysql-proxy来代理，可以至暴露一个地址，然后将读写分流至不同的mysql实例


## 结果
经咨询DBA大佬，的值现在web服务使用的mysql实例是读写分离的，在mysql压力较大时可能会出现从库同步时延较大的情况，解决方案有两种
1. 写入完成后通过在查询语句前添加`/*master*/`的指定读取主库
2. 读取时增加错误重试，但是超时时间并不固定，所以这个方案并不能完全解决
3. 关闭读写分离功能，这样不用修改代码，即可完成，目前的mysql压力并不大，可以考虑这种方案