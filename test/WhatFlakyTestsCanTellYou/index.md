# 从不稳定测试用例中可以学到什么？
>译者注：  
原文链接"https://www.stickyminds.com/print/article/what-flaky-tests-can-tell-you"  
作者[Josh Grant](https://www.stickyminds.com/users/josh-grant)(版权所有)

假如：你是一个负责编写web应用端到端测试用例的测试开发人员。你用的是好用、流行的技术，比如Selenium WebDriver。你考虑利用page对象将测试从应用逻辑中分隔开来以优雅地完成开发工作。你懂得利用虚拟化技术和适当强化的硬件。你明白端到端测试是整个团队的共同努力的结果，所以你同应用开发、测试和管理人员共同协作来最大化你的工作价值。尽管你做的滴水不漏，但仍然会碰到一个经常出现的问题：不稳定的测试用例。

不稳定的测试用例(flaky test)是指因为一些随机原因导致的用例意外通过或失败。随着用例集规模增长和应用覆盖率的提升，不稳定测试用例的问题会越来越严重。最后会让你忍不住扬天长啸， "这都是什么玩意！？"然后一怒之下整个端到端测试集都扔到垃圾箱。

但是，不稳定测试用例真的是个问题吗？

删除不稳定用例，甚至藉此放弃整个端到端测试集都很容易。但是从中我们可以获取到很多关于项目和团队的动态信息。下面我会提供几个关于技术、人员的例子来说明如何利用不稳定测试用例帮助进行软件测试工作，这也许对你有帮助。

### 从技术角度来说

基于WebDriver的测试用例有一些常见导致不稳定的原因。其中一个元凶就是同步性（或者说缺少同步性）。web应用模型存在很多层都可以影响到性能，包括网络连接速度、HTTP处理、渲染和资源处理。因此，相同端到端测试用例的一些操作在不同运行批次上的耗时可能存在细微的差别。比如按钮出现的不够及时，或者对话框消失地不够快使得自动化脚本无法结束。

一个解决方案是添加一个wait语句使得脚本与应用的步调一致。这看起来像是避免不稳定性的hack手段，但其同时也可能指出了应用中性能问题。如果某些地方需要持续地等待或者等待时间需要不停地加长，这说明这些地方的性能，尤其是客户端，存在问题。就我曾经工作过的一个团队举例，有一个自动化端到端测试用例集偶尔会失败，但是都是同一个功能。当我把这个现象告诉研发，最终发现是因为一些糟糕的代码实践所引发的前端问题导致的。不稳定测试用例直接或间接地帮助我们发现了问题。

另外一个问题是在性能测试中出现的不稳定测试用例。随着端到端测试集的增长，测试代码的规模会随之增加，需要执行的用例也会变得很多。这个时候通常需要并行执行测试集以降低测试运行时间。尽管这对开发和测试有帮助，但是存在一些副作用，给你的应用施加较大压力，会意外引入压力测试。

串行执行端到端测试没问题，但并行执行时会出现不稳定的情况。曾经一个项目中，一些用例在单独运行的时候没有任何问题，但是并行运行的时候，会有小概率（看起来像是随机一样）出现失败。经过一番调试，我的一个同事发现，当用例并行运行时，每个用例都会尝试登陆同一个管理员账户，导致差不多同一个用户的8个并发登陆请求。然而应用并没有预料到这种情况，所以我们就发现了这个坑，但是这个不稳定用例是有益的，其帮助我们改进了用例。

### 从人员角度来说

不稳定用例的一个好处是可以作为团队交流情况的晴雨表。我曾经遇到过几次挑战是如何让团队成员关注端到端测试集的运行结果。因为不稳定的测试偶尔会出现失败的情况，感兴趣的成员，也就是真正关注测试结果的人，会询问用例的情况。即使答案仅仅是"他们不稳定"，这通常也是一个好的话头，可以开始关于测试、质量和自动化方法的交流。

根据我的经验，如果存在不稳定的用例，并且没有人询问相关情况的话，那么你的团队要么没有收到测试结果，要么是没人关注。如果是没有收到结果的话还好办，但是有时候得有一些技巧才能发现。要不是我跟合作的研发聊天，我还不会发现研发看不懂CI服务器上的测试报告，这个情况是部分由于研发想要知道为什么有的测试用例会失败。而如果是你的团队对测试结果漠不关心的话，那么你就需要用一点小心思去引起他们的注意力了。

除开测试兴趣的度量功能，不稳定测试揭露了"测试结果疲劳"这种状况，即团队成员常常被不可靠的测试结果骚扰而选择忽视测试结果的情况。测试结果疲劳会吞噬掉自动化所带来的收益，而主要原因就是不稳定的测试用例。原本前途光明的测试努力可能会渐渐被团队成员的忽略不稳定用例的结果而毁掉，然后就是整个测试结果。观察你的团队对不稳定用例的反应的变化情况，你或许会知道他们对自动化投入的变化情况，即使团队已经过了使用新工具的蜜月期。这也能帮你在任何时期观察你的团队在项目中的参与度。

最后，思考如何将自动化端到端测试应用在你的团队或项目实际中。在采用持续集成的团队或组织里，通过所有的自动化端到端测试用例是产品构建或发布的前提。不稳定测试会终止构建或发布过程是个需要注意的地方。这个情况下，自动化端到端测试实际上是验收测试（或者说是拒绝点检查）并且应该被这么对待。有的团队用自动化端到端测试作为回归测试，在发布前检查某些已知的bug是否仍然存在，他们对待不稳定测试的就会不一样。这种情况下，可以由人来根据情况解释测试结果。两种方法都是可靠的，重要的是理解你团队所采用的方式。

### 将不稳定测试变为你的优势

要将不稳定测试结果当做自动化工具的问题删掉，同时放弃使用工具很简单。或者，你也可以选择继续使用工具但是不采信结果。

而我建议采用第三种方案：深入发掘不稳定测试的原因以找出系统中的实际问题。问题可能是关于性能、状态或者速度的。不管怎么样，都要把不稳定测试当做朋友。

它尝试告诉你什么东西，不要错过了。
